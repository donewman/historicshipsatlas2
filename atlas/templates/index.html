{% extends "base_generic.html" %}

{% block title %}
  <title>Home - Historic Ships Atlas</title>
{% endblock %}

{% block head %}
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css" rel="stylesheet" />
{% endblock %}

{% block content %}
  <h1>Home</h1>
  <p>Welcome to the Historic Ships Atlas!</p>
  <p>The markers with anchor icons on the map represent the locations of ships with static positions. The markers with ship icons represent the current locations of active ships. Click on the markers to see more about each ship. Or, use the search box in the navigation or the <a href="{% url 'advanced_search' %}">Advanced Search</a> to search for ships, or simply view <a href="{% url 'ships' %}">All Ships</a>.</p>
  <div id="map" style="height: 600px;"></div>
{% endblock %}

{% block script %}
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js"></script>
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
<script type="text/javascript">
  var static_ships_features = [];
  for (var i = 0; i < {{ static_ships_json|safe }}.length; i++) {
    static_ships_features.push({
      'type': 'Feature',
      'geometry': {
          'type': 'Point',
          'coordinates': [{{ static_ships_json|safe }}[i].fields.lon, {{ static_ships_json|safe }}[i].fields.lat]
      },
      'properties': {
          'description': '<h3>' +
            {{ static_ships_json|safe }}[i].fields.name +
            '</h3><table><tr><td>' +
            {{ static_ships_json|safe}}[i].fields.type +
            '</td></tr><tr><td>' +
            {{ static_ships_json|safe }}[i].fields.status +
            '</td></tr><tr><td>' +
            {{ static_ships_json|safe }}[i].fields.city +
            ', ' +
            {{ static_ships_json|safe }}[i].fields.country +
            '</td></tr></table><p><a href="/atlas/ship/' +
            {{ static_ships_json|safe }}[i].fields.slug +
            '">Ship Details >>></a></p>',
          'icon': 'harbor'
      }
    },
  );}
  mapboxgl.accessToken = 'pk.eyJ1IjoiZG91Z25ld21hbiIsImEiOiJjam5vODkwaHQwNm1qM3BxbHV6YmlidWFoIn0.3rN2nNWL5-Ie_euOFrChbg';
  var map = new mapboxgl.Map({
      container: 'map',
      center: [0, 0],
      zoom: 1,
      style: 'mapbox://styles/mapbox/satellite-streets-v10'
  });
  map.on('load', function () {
    var nav = new mapboxgl.NavigationControl();
    map.addControl(nav, 'top-left');
    map.addLayer({
        'id': 'static_ships',
        'type': 'symbol',
        'source': {
            'type': 'geojson',
            'data': {
                'type': 'FeatureCollection',
                'features': static_ships_features,
            }
        },
        'layout': {
            'icon-image': '{icon}-15',
            'icon-allow-overlap': true,
        },
    });
    map.on('click', 'static_ships', function (e) {
        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = e.features[0].properties.description;
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }
        new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
    });
    map.on('mouseenter', 'static_ships', function () {
        map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'static_ships', function () {
        map.getCanvas().style.cursor = '';
    });
  });
  fetch('https://www.fleetmon.com/api/p/personal-v1/myfleet/?username=dougnewman&api_key=4320bb316a86f03cccb627ce0f031905664d902c&format=json', {
    headers: {
      'Accept': 'application/json'
    },
  })
  .then(function(response) {
    return response.json();
  })
  .then(function(myJson) {
    var ais = myJson;
    console.log(ais);
    var active_ships_features = [];
    for (var i = 0; i < ais.objects.length; i++) {
      slug = ais.objects[i].vessel.name.replace(/\s+/g, '-').toLowerCase();
      active_ships_features.push({
        'type': 'Feature',
        'geometry': {
            'type': 'Point',
            'coordinates': [ais.objects[i].vessel.longitude, ais.objects[i].vessel.latitude]
        },
        'properties': {
            'description': '<h3>' +
              ais.objects[i].vessel.name +
              '</h3></p><table><tr><th scope="row">Current Location:</th><td>' +
              ais.objects[i].vessel.location +
              '</td></tr><tr><th scope="row">Navigational Status:</th><td>' +
              ais.objects[i].vessel.navigationstatus +
              '</td></tr><tr><th scope="row">Speed:</th><td>' +
              ais.objects[i].vessel.speed +
              ' kn</td></tr><tr><th scope="row">Last Updated:</th><td>' +
              ais.objects[i].vessel.positionreceived +
              '</td></tr></table><p><a href="/atlas/ship/' +
              slug +
              '">Ship Details >>></a></p><p><a target="_blank"  href="https:' +
              ais.objects[i].vessel.publicurl +
              '">More Information from FleetMon >>></a></p>',
            'icon': 'ferry'
        }
      },
    );}
    console.log(active_ships_features);
    map.on('load', function () {
      map.addLayer({
          'id': 'active_ships',
          'type': 'symbol',
          'source': {
              'type': 'geojson',
              'data': {
                  'type': 'FeatureCollection',
                  'features': active_ships_features
              }
          },
          'layout': {
              'icon-image': '{icon}-15',
              'icon-allow-overlap': true,
          },
      });
      map.on('click', 'active_ships', function (e) {
          var coordinates = e.features[0].geometry.coordinates.slice();
          var description = e.features[0].properties.description;
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
          new mapboxgl.Popup()
              .setLngLat(coordinates)
              .setHTML(description)
              .addTo(map);
      });
      map.on('mouseenter', 'active_ships', function () {
          map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'active_ships', function () {
          map.getCanvas().style.cursor = '';
      });
    });
  });
</script>
{% endblock %}
